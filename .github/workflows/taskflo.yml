# # name: Compliance Email Automation

# # on:
# #   schedule:
# #     # Daily reminders - every day at 9:00 AM Pakistan Time (4:00 AM UTC)
# #     - cron: '0 4 * * *'

# #     # Monthly tasks - 1st of every month at 9:00 AM Pakistan Time (4:00 AM UTC)
# #     - cron: '0 4 1 * *'

# #     # Quarterly tasks - 25th of quarter-end months (Mar, Jun, Sep, Dec) at 9:00 AM Pakistan Time (4:00 AM UTC)
# #     - cron: '0 4 25 3,6,9,12 *'

# #     # Weekly reminders - every Monday at 9:00 AM Pakistan Time (4:00 AM UTC)
# #     - cron: '0 4 * * 1'

# #     # Escalation reports - every day at 11:00 AM Pakistan Time (6:00 AM UTC)
# #     - cron: '0 5 * * *'

# #   workflow_dispatch:
# #     inputs:
# #       schedule_type:
# #         description: 'Schedule type to run manually'
# #         required: true
# #         default: 'daily'
# #         type: choice
# #         options:
# #           - daily
# #           - monthly
# #           - quarterly
# #           - reminder
# #           - escalation
# #       dry_run:
# #         description: 'Run in dry-run mode (no emails sent)'
# #         required: false
# #         default: true
# #         type: boolean

# # jobs:
# #   send-compliance-emails:
# #     runs-on: ubuntu-latest
# #     environment: 'env'

# #     steps:
# #       - name: Checkout repository
# #         uses: actions/checkout@v4

# #       - name: Set up Python
# #         uses: actions/setup-python@v4
# #         with:
# #           python-version: '3.9'

# #       - name: Install dependencies
# #         run: |
# #           python -m pip install --upgrade pip
# #           pip install pandas python-dotenv

# #       - name: Determine schedule type
# #         id: schedule_type
# #         run: |
# #           if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
# #             echo "TYPE=${{ github.event.inputs.schedule_type }}" >> $GITHUB_OUTPUT
# #             echo "DRY_RUN=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
# #           else
# #             CURRENT_DAY=$(date +%d)
# #             CURRENT_MONTH=$(date +%m)
# #             CURRENT_DOW=$(date +%u)  # 1=Monday
# #             CURRENT_HOUR=$(date +%H)

# #             # Determine schedule type based on time (UTC)
# #             if [ "$CURRENT_HOUR" = "04" ]; then  # 9 AM PKT
# #               if [ "$CURRENT_DAY" = "01" ]; then
# #                 echo "TYPE=monthly" >> $GITHUB_OUTPUT
# #               elif [ "$CURRENT_DAY" = "25" ] && [[ "$CURRENT_MONTH" =~ ^(03|06|09|12)$ ]]; then
# #                 echo "TYPE=quarterly" >> $GITHUB_OUTPUT
# #               elif [ "$CURRENT_DOW" = "1" ]; then
# #                 echo "TYPE=reminder" >> $GITHUB_OUTPUT
# #               else
# #                 echo "TYPE=daily" >> $GITHUB_OUTPUT
# #               fi
# #             elif [ "$CURRENT_HOUR" = "06" ]; then  # 11 AM PKT
# #               echo "TYPE=escalation" >> $GITHUB_OUTPUT
# #             else
# #               echo "TYPE=skip" >> $GITHUB_OUTPUT
# #             fi

# #             echo "DRY_RUN=false" >> $GITHUB_OUTPUT
# #           fi

# #       - name: Debug environment
# #         run: |
# #           echo "=== ENVIRONMENT DEBUG ==="
# #           echo "Environment: ${{ job.environment }}"
# #           echo "Schedule type: ${{ steps.schedule_type.outputs.TYPE }}"
# #           echo "Dry run: ${{ steps.schedule_type.outputs.DRY_RUN }}"
# #           echo "Date: $(date +%Y-%m-%d)"
# #           echo "Time (UTC): $(date +%H:%M:%S)"

# #       - name: Run Compliance System
# #         if: steps.schedule_type.outputs.TYPE != 'skip'
# #         env:
# #           SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
# #           SMTP_PORT: ${{ secrets.SMTP_PORT }}
# #           SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
# #           SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
# #         run: |
# #           echo "Running compliance emails for schedule type: ${{ steps.schedule_type.outputs.TYPE }}"
# #           if [ "${{ steps.schedule_type.outputs.DRY_RUN }}" = "true" ]; then
# #             echo "🚀 Running in DRY-RUN mode (no emails sent)"
# #             python script.py "${{ steps.schedule_type.outputs.TYPE }}" --dry-run
# #           else
# #             echo "📧 Running in LIVE mode (emails will be sent)"
# #             python script.py "${{ steps.schedule_type.outputs.TYPE }}"
# #           fi

# #       - name: Skip execution
# #         if: steps.schedule_type.outputs.TYPE == 'skip'
# #         run: echo "⏭️ No matching schedule — skipping execution."

# #       - name: Success notification
# #         if: success() && steps.schedule_type.outputs.TYPE != 'skip'
# #         run: |
# #           echo "✅ ${{ steps.schedule_type.outputs.TYPE }} compliance automation completed successfully!"


# name: Compliance Email Automation

# on:
#   schedule:
#     # Daily reminders - every day at 9:00 AM Pakistan Time (4:00 AM UTC)
#     - cron: '0 4 * * *'

#     # Monthly tasks - 1st of every month at 9:00 AM Pakistan Time (4:00 AM UTC)
#     - cron: '0 4 1 * *'

#     # Quarterly tasks - 25th of quarter-end months (Mar, Jun, Sep, Dec) at 9:00 AM Pakistan Time (4:00 AM UTC)
#     - cron: '0 4 25 3,6,9,12 *'

#     # Weekly reminders - every Monday at 9:00 AM Pakistan Time (4:00 AM UTC)
#     - cron: '0 4 * * 1'

#     # Escalation reports - every day at 11:00 AM Pakistan Time (6:00 AM UTC)
#     - cron: '0 6 * * *'

#   workflow_dispatch:
#     inputs:
#       schedule_type:
#         description: 'Schedule type to run manually'
#         required: true
#         default: 'daily'
#         type: choice
#         options:
#           - daily
#           - monthly
#           - quarterly
#           - reminder
#           - escalation
#       dry_run:
#         description: 'Run in dry-run mode (no emails sent)'
#         required: false
#         default: true
#         type: boolean

# jobs:
#   send-compliance-emails:
#     runs-on: ubuntu-latest
#     environment: 'production'

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: '3.9'

#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install pandas python-dotenv pymongo streamlit

#       - name: Create Streamlit secrets file for MongoDB
#         run: |
#           mkdir -p .streamlit
#           cat > .streamlit/secrets.toml << EOF
#           [mongodb]
#           uri = "${{ secrets.MONGODB_URI }}"
#           EOF
#           echo "✅ Created Streamlit secrets file"

#       - name: Determine schedule type
#         id: schedule_type
#         run: |
#           if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
#             echo "TYPE=${{ github.event.inputs.schedule_type }}" >> $GITHUB_OUTPUT
#             echo "DRY_RUN=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
#           else
#             CURRENT_DAY=$(date +%d)
#             CURRENT_MONTH=$(date +%m)
#             CURRENT_DOW=$(date +%u)  # 1=Monday
#             CURRENT_HOUR=$(date +%H)

#             echo "Current date: $(date)"
#             echo "Day: $CURRENT_DAY, Month: $CURRENT_MONTH, Day of week: $CURRENT_DOW, Hour: $CURRENT_HOUR"

#             # Determine schedule type based on time (UTC)
#             if [ "$CURRENT_HOUR" = "04" ]; then  # 9 AM PKT
#               if [ "$CURRENT_DAY" = "01" ]; then
#                 echo "TYPE=monthly" >> $GITHUB_OUTPUT
#                 echo "📅 Detected 1st of month - running monthly tasks"
#               elif [ "$CURRENT_DAY" = "25" ] && [[ "$CURRENT_MONTH" =~ ^(03|06|09|12)$ ]]; then
#                 echo "TYPE=quarterly" >> $GITHUB_OUTPUT
#                 echo "📅 Detected 25th of quarter-end month - running quarterly tasks"
#               elif [ "$CURRENT_DOW" = "1" ]; then
#                 echo "TYPE=reminder" >> $GITHUB_OUTPUT
#                 echo "📅 Detected Monday - running weekly reminders"
#               else
#                 echo "TYPE=daily" >> $GITHUB_OUTPUT
#                 echo "📅 Running daily tasks"
#               fi
#             elif [ "$CURRENT_HOUR" = "06" ]; then  # 11 AM PKT
#               echo "TYPE=escalation" >> $GITHUB_OUTPUT
#               echo "📅 Running escalation reports"
#             else
#               echo "TYPE=skip" >> $GITHUB_OUTPUT
#               echo "⏭️ No matching schedule for current time"
#             fi

#             echo "DRY_RUN=false" >> $GITHUB_OUTPUT
#           fi

#       - name: Debug environment
#         run: |
#           echo "=== ENVIRONMENT DEBUG ==="
#           echo "Environment: ${{ job.environment }}"
#           echo "Schedule type: ${{ steps.schedule_type.outputs.TYPE }}"
#           echo "Dry run: ${{ steps.schedule_type.outputs.DRY_RUN }}"
#           echo "Date: $(date +%Y-%m-%d)"
#           echo "Time (UTC): $(date +%H:%M:%S)"
#           echo "Python version: $(python --version)"
#           echo "Current directory: $(pwd)"
#           echo "Directory contents:"
#           ls -la
#           echo "Streamlit secrets directory:"
#           ls -la .streamlit/ || echo "No .streamlit directory"

#       - name: Test MongoDB connection
#         if: steps.schedule_type.outputs.TYPE != 'skip'
#         env:
#           MONGODB_URI: ${{ secrets.MONGODB_URI }}
#         run: |
#           echo "Testing MongoDB connection..."
#           python -c "
#           import os
#           from pymongo import MongoClient
#           from pymongo.errors import ConnectionFailure
#           try:
#               client = MongoClient(os.environ.get('MONGODB_URI'))
#               client.admin.command('ping')
#               print('✅ MongoDB connection successful')
              
#               # Test database access
#               db = client['task_management_db']
#               tasks_count = db.tasks.count_documents({})
#               users_count = db.users.count_documents({})
#               print(f'📊 Database stats: {tasks_count} tasks, {users_count} users')
              
#               client.close()
#           except Exception as e:
#               print(f'❌ MongoDB connection failed: {e}')
#               exit(1)
#           "

#       - name: Run Compliance System
#         if: steps.schedule_type.outputs.TYPE != 'skip'
#         env:
#           SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
#           SMTP_PORT: ${{ secrets.SMTP_PORT }}
#           SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
#           SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
#           MONGODB_URI: ${{ secrets.MONGODB_URI }}
#         run: |
#           echo "Running compliance emails for schedule type: ${{ steps.schedule_type.outputs.TYPE }}"
#           if [ "${{ steps.schedule_type.outputs.DRY_RUN }}" = "true" ]; then
#             echo "🚀 Running in DRY-RUN mode (no emails sent)"
#             python -c "
#             import sys
#             sys.path.append('.')
#             from your_script_filename import ComplianceEmailSystem  # Replace with your actual filename
            
#             system = ComplianceEmailSystem()
#             if '${{ steps.schedule_type.outputs.TYPE }}' == 'escalation':
#                 result = system.send_escalation_reports(dry_run=True)
#             else:
#                 result = system.process_tasks('${{ steps.schedule_type.outputs.TYPE }}', dry_run=True)
#             print('Dry run result:', result)
#             "
#           else
#             echo "📧 Running in LIVE mode (emails will be sent)"
#             python -c "
#             import sys
#             sys.path.append('.')
#             from your_script_filename import ComplianceEmailSystem  # Replace with your actual filename
            
#             system = ComplianceEmailSystem()
#             if '${{ steps.schedule_type.outputs.TYPE }}' == 'escalation':
#                 result = system.send_escalation_reports(dry_run=False)
#             else:
#                 result = system.process_tasks('${{ steps.schedule_type.outputs.TYPE }}', dry_run=False)
#             print('Live run result:', result)
#             "
#           fi

#       - name: Skip execution
#         if: steps.schedule_type.outputs.TYPE == 'skip'
#         run: echo "⏭️ No matching schedule — skipping execution."

#       - name: Success notification
#         if: success() && steps.schedule_type.outputs.TYPE != 'skip'
#         run: |
#           echo "✅ ${{ steps.schedule_type.outputs.TYPE }} compliance automation completed successfully!"
#           echo "📊 Schedule type: ${{ steps.schedule_type.outputs.TYPE }}"
#           echo "🎯 Dry run: ${{ steps.schedule_type.outputs.DRY_RUN }}"

#       - name: Failure notification
#         if: failure() && steps.schedule_type.outputs.TYPE != 'skip'
#         run: |
#           echo "❌ ${{ steps.schedule_type.outputs.TYPE }} compliance automation failed!"
#           echo "Please check the logs for details."

name: Compliance Email Automation

on:
  schedule:
    # Daily reminders - every day at 9:00 AM Pakistan Time (4:00 AM UTC)
    - cron: '0 4 * * *'
    # Monthly tasks - 1st of every month at 9:00 AM Pakistan Time (4:00 AM UTC)
    - cron: '0 4 1 * *'
    # Quarterly tasks - 25th of quarter-end months (Mar, Jun, Sep, Dec) at 9:00 AM Pakistan Time (4:00 AM UTC)
    - cron: '0 4 25 3,6,9,12 *'
    # Weekly reminders - every Monday at 9:00 AM Pakistan Time (4:00 AM UTC)
    - cron: '0 4 * * 1'
    # Escalation reports - every day at 11:00 AM Pakistan Time (6:00 AM UTC)
    - cron: '0 6 * * *'

  workflow_dispatch:
    inputs:
      schedule_type:
        description: 'Schedule type to run manually'
        required: true
        default: 'daily'
        type: choice
        options:
          - daily
          - monthly
          - quarterly
          - reminder
          - escalation
      dry_run:
        description: 'Run in dry-run mode (no emails sent)'
        required: false
        default: true
        type: boolean

jobs:
  send-compliance-emails:
    runs-on: ubuntu-latest
    environment: 'production'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas python-dotenv pymongo streamlit

      - name: Create Streamlit secrets file for MongoDB
        run: |
          mkdir -p .streamlit
          cat > .streamlit/secrets.toml << EOF
          [mongodb]
          uri = "${{ secrets.MONGODB_URI }}"
          EOF
          echo "✅ Created Streamlit secrets file"
          # Verify the file was created
          echo "Secrets file content (first 50 chars):"
          head -c 50 .streamlit/secrets.toml
          echo ""

      - name: Determine schedule type
        id: schedule_type
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "TYPE=${{ github.event.inputs.schedule_type }}" >> $GITHUB_OUTPUT
            echo "DRY_RUN=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
          else
            CURRENT_DAY=$(date +%d)
            CURRENT_MONTH=$(date +%m)
            CURRENT_DOW=$(date +%u)  # 1=Monday
            CURRENT_HOUR=$(date +%H)

            echo "Current date: $(date)"
            echo "Day: $CURRENT_DAY, Month: $CURRENT_MONTH, Day of week: $CURRENT_DOW, Hour: $CURRENT_HOUR"

            # Determine schedule type based on time (UTC)
            if [ "$CURRENT_HOUR" = "04" ]; then  # 9 AM PKT
              if [ "$CURRENT_DAY" = "01" ]; then
                echo "TYPE=monthly" >> $GITHUB_OUTPUT
                echo "📅 Detected 1st of month - running monthly tasks"
              elif [ "$CURRENT_DAY" = "25" ] && [[ "$CURRENT_MONTH" =~ ^(03|06|09|12)$ ]]; then
                echo "TYPE=quarterly" >> $GITHUB_OUTPUT
                echo "📅 Detected 25th of quarter-end month - running quarterly tasks"
              elif [ "$CURRENT_DOW" = "1" ]; then
                echo "TYPE=reminder" >> $GITHUB_OUTPUT
                echo "📅 Detected Monday - running weekly reminders"
              else
                echo "TYPE=daily" >> $GITHUB_OUTPUT
                echo "📅 Running daily tasks"
              fi
            elif [ "$CURRENT_HOUR" = "06" ]; then  # 11 AM PKT
              echo "TYPE=escalation" >> $GITHUB_OUTPUT
              echo "📅 Running escalation reports"
            else
              echo "TYPE=skip" >> $GITHUB_OUTPUT
              echo "⏭️ No matching schedule for current time"
            fi

            echo "DRY_RUN=false" >> $GITHUB_OUTPUT
          fi

      - name: Test MongoDB connection
        if: steps.schedule_type.outputs.TYPE != 'skip'
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: |
          echo "Testing MongoDB connection..."
          echo "MongoDB URI length: ${#MONGODB_URI}"
          
          # Create a simple Python test script
          cat > test_mongodb.py << 'EOF'
          import os
          import sys
          from pymongo import MongoClient
          from pymongo.errors import ConnectionFailure, ConfigurationError

          mongodb_uri = os.environ.get('MONGODB_URI', '').strip()
          
          print(f"MongoDB URI present: {'Yes' if mongodb_uri else 'No'}")
          print(f"URI length: {len(mongodb_uri)}")
          
          if not mongodb_uri:
              print("❌ ERROR: MONGODB_URI environment variable is empty")
              sys.exit(1)
              
          try:
              print("Attempting to connect to MongoDB...")
              client = MongoClient(mongodb_uri, serverSelectionTimeoutMS=5000)
              
              # Test connection
              client.admin.command('ping')
              print('✅ MongoDB connection successful')
              
              # Test database access
              db = client['task_management_db']
              tasks_count = db.tasks.count_documents({})
              users_count = db.users.count_documents({})
              print(f'📊 Database stats: {tasks_count} tasks, {users_count} users')
              
              client.close()
              
          except ConnectionFailure as e:
              print(f'❌ MongoDB connection failed: {e}')
              sys.exit(1)
          except ConfigurationError as e:
              print(f'❌ MongoDB configuration error: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'❌ Unexpected error: {e}')
              sys.exit(1)
          EOF
          
          python test_mongodb.py

      - name: Run Compliance System
        if: steps.schedule_type.outputs.TYPE != 'skip'
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: |
          echo "Running compliance emails for schedule type: ${{ steps.schedule_type.outputs.TYPE }}"
          
          if [ "${{ steps.schedule_type.outputs.DRY_RUN }}" = "true" ]; then
            echo "🚀 Running in DRY-RUN mode (no emails sent)"
            python -c "
            import sys
            sys.path.append('.')
            try:
                from script import ComplianceEmailSystem
                system = ComplianceEmailSystem()
                if '${{ steps.schedule_type.outputs.TYPE }}' == 'escalation':
                    result = system.send_escalation_reports(dry_run=True)
                else:
                    result = system.process_tasks('${{ steps.schedule_type.outputs.TYPE }}', dry_run=True)
                print('Dry run result:', result)
            except ImportError as e:
                print(f'❌ Import error: {e}')
                print('Make sure script.py contains ComplianceEmailSystem class')
                import traceback
                traceback.print_exc()
            except Exception as e:
                print(f'❌ Error: {e}')
                import traceback
                traceback.print_exc()
            "
          else
            echo "📧 Running in LIVE mode (emails will be sent)"
            python -c "
            import sys
            sys.path.append('.')
            try:
                from script import ComplianceEmailSystem
                system = ComplianceEmailSystem()
                if '${{ steps.schedule_type.outputs.TYPE }}' == 'escalation':
                    result = system.send_escalation_reports(dry_run=False)
                else:
                    result = system.process_tasks('${{ steps.schedule_type.outputs.TYPE }}', dry_run=False)
                print('Live run result:', result)
            except ImportError as e:
                print(f'❌ Import error: {e}')
                print('Make sure script.py contains ComplianceEmailSystem class')
                import traceback
                traceback.print_exc()
            except Exception as e:
                print(f'❌ Error: {e}')
                import traceback
                traceback.print_exc()
            "
          fi

      - name: Skip execution
        if: steps.schedule_type.outputs.TYPE == 'skip'
        run: echo "⏭️ No matching schedule — skipping execution."

      - name: Success notification
        if: success() && steps.schedule_type.outputs.TYPE != 'skip'
        run: |
          echo "✅ ${{ steps.schedule_type.outputs.TYPE }} compliance automation completed successfully!"
          echo "📊 Schedule type: ${{ steps.schedule_type.outputs.TYPE }}"
          echo "🎯 Dry run: ${{ steps.schedule_type.outputs.DRY_RUN }}"

      - name: Failure notification
        if: failure() && steps.schedule_type.outputs.TYPE != 'skip'
        run: |
          echo "❌ ${{ steps.schedule_type.outputs.TYPE }} compliance automation failed!"
          echo "Please check the logs for details."











